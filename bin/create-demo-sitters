#!/usr/bin/env coffee

_ = require 'underscore'
Q = require 'q'
Q.longStackSupport = true
_(global).extend require('../lib/models')
sitters = require '../data/sitters.json'

createSittersP = Q.all sitters.map (sitterData) ->
  sitterId = sitterData.id
  sitterData = _.extend {}, sitterData
  delete sitterData.id

  console.info 'Updating', sitterId, sitterData.name
  Sitter.findOrCreate(id:sitterId)
  .then (sitter) ->
    sitter.updateAttributes(data:sitterData, is_simulated:true)
  .then (sitter) -> sitter.getUser()
  .then (user) ->
    Q.when(user or User.create().then (user) -> user.setSitter(sitter))
    .then (user) ->
      userAttributes =
        displayName: sitterData.name
        email: "sitter-#{sitterId}@sevensitters.com"
        phone: "415 555-000#{sitterId}"
      Q.all [
        user.updateAttributes userAttributes
        user.getAccounts()
        .then (accounts) ->
          accountAttributes =
            user_id          : user.id
            provider_name    : 'facebook'
            provider_user_id : String(172347878787877 + sitterId)
          accounts.length or Account.create(accountAttributes)
        ]

createSittersP
  .catch( (error) -> console.error error )
  .done ->
    process.exit()
